; =============================================================================
; CallScript V2 - Supervisor Configuration
; =============================================================================
; Manages all workers with auto-restart on crash/reboot.
;
; Usage:
;   supervisord -c /workspace/supervisord.conf    # Start all workers
;   supervisorctl status                          # Check status
;   supervisorctl restart all                     # Restart all
;   supervisorctl stop factory:*                  # Stop factory workers
;   supervisorctl tail -f ingest                  # Follow ingest logs
;
; Install supervisor (if not present):
;   apt-get install supervisor
;   pip install supervisor
; =============================================================================

[supervisord]
nodaemon=false
logfile=/workspace/logs/supervisord.log
pidfile=/workspace/pids/supervisord.pid
childlogdir=/workspace/logs
directory=/workspace
environment=PYTHONPATH="/workspace"

[unix_http_server]
file=/tmp/supervisor.sock

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; =============================================================================
; INGEST LANE (1 worker)
; =============================================================================
[program:ingest]
command=/usr/bin/python3 /workspace/workers/ingest/worker.py
directory=/workspace
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stderr_logfile=/workspace/logs/ingest.err.log
stdout_logfile=/workspace/logs/ingest.log
environment=PYTHONPATH="/workspace"

; =============================================================================
; VAULT LANE (1 worker)
; =============================================================================
[program:vault]
command=/usr/bin/python3 /workspace/workers/vault/worker.py
directory=/workspace
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stderr_logfile=/workspace/logs/vault.err.log
stdout_logfile=/workspace/logs/vault.log
environment=PYTHONPATH="/workspace"

; =============================================================================
; JUDGE LANE (1 worker)
; =============================================================================
[program:judge]
command=/usr/bin/python3 /workspace/workers/judge/worker.py
directory=/workspace
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stderr_logfile=/workspace/logs/judge.err.log
stdout_logfile=/workspace/logs/judge.log
environment=PYTHONPATH="/workspace"

; =============================================================================
; FACTORY LANE (4 workers - GPU transcription)
; =============================================================================
[program:factory]
command=/usr/bin/python3 /workspace/workers/factory/worker.py
directory=/workspace
process_name=%(program_name)s_%(process_num)02d
numprocs=4
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=60
stderr_logfile=/workspace/logs/factory_%(process_num)02d.err.log
stdout_logfile=/workspace/logs/factory_%(process_num)02d.log
environment=PYTHONPATH="/workspace"

; =============================================================================
; HEALTH SERVER (1 instance)
; =============================================================================
[program:health_server]
command=/usr/bin/python3 /workspace/workers/health_server.py
directory=/workspace
autostart=true
autorestart=true
startsecs=5
startretries=3
stopwaitsecs=10
stderr_logfile=/workspace/logs/health_server.err.log
stdout_logfile=/workspace/logs/health_server.log
environment=PYTHONPATH="/workspace",HEALTH_PORT="8080"

; =============================================================================
; GROUP DEFINITIONS
; =============================================================================
[group:callscript]
programs=ingest,vault,judge,factory,health_server
priority=999
